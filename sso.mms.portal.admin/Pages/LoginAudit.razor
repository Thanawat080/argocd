@page "/loginaudit"

@using sso.mms.helper.Configs;
@using sso.mms.login.Services;
@using sso.mms.login.ViewModels.KeyCloak;
@using sso.mms.helper.Utility;
@inject KeyCloakService keyCloakService
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<style>
        :root {
        --mdc-theme-primary: #334396;
    }

    .form-control, .form-select {
        display: block;
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: var(--bs-body-color);
        background-color: var(--bs-body-bg);
        background-clip: padding-box;
        border: var(--bs-border-width) solid #9e9e9e;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border-radius: var(--bs-border-radius-sm);
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        height: 3rem;
    }

    @@media only screen and (min-width: 1000px) {
        .pm-xl {
            position: fixed;
            width: 100%;
            z-index: 1000;
        }
    }

    @@media only screen and (max-width: 1000px) {
        .position-class {
            position: relative
        }
    }

    @@media only screen and (max-width: 998px) {
        .card-c-login {
            margin-top: 10%;
        }
    }

</style>

    <nav class="nav-s-l">
        <div class="d-flex">
            <img class="l-a" src="Image/navlogo.png" />
        </div>
    </nav>

<MediaStyle></MediaStyle>

@if (isLoading == true)
{
    <style>body { overflow: hidden; }</style><LoadingPage></LoadingPage>

}
<div class="row">
    <div class="col col-xl-6 bg-color-a">
        <div class="card-c-login">
            <div class="container m-2 mt-5" align="center">
                <div class="card-index-true">
                    <img src="Image/logologin.png" style="width:96px;height:96px;margin-top:3rem" />
                    <p class="txt-login-a f48">เข้าสู่ระบบ</p>
                    <p class="txt-login-a f22">สำหรับเจ้าหน้าที่ Auditor</p>
                    <form class="container txt-l-b f22">
                        <div class="form-outline mb-4 w-75">
                            <label class="text-login float-start" for="form2Example1">ชื่อผู้ใช้</label><p class="float-start" style="color:red">*</p>
                            <input type="text" id="form2Example1" class="form-control txt-label-login" @bind="username" />
                        </div>
                        <div class="form-outline mb-4 w-75">
                            <label class="text-login float-start" for="form2Example1">รหัสผ่าน</label><p class="float-start" style="color:red">*</p>
                            <div class="input-group mb-2">
                                <input class="form-control input-c input-txt-from" type="@((showPassword ? "text" : "password"))" id="otp" name="fav_language" @bind="password" style="border-radius: 6px 0px 0px 6px;">
                                <div class="input-group-prepend">
                                    <div class="input-txt-eye" @onclick="TogglePasswordVisibility">
                                        <i class="@((showPassword ? "fa-solid fa-eye" : "fa-sharp fa-solid fa-eye-slash"))" style="padding-top:10px;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-5 m-2">
                        </div>
                        <button type="button" class="btn btn-primary btn-login-a mb-4 w-75" @onclick=IsLogin>
                            <img src="Image/loginlogo.png" style="width:20px;height:20px;margin-right:10px;" />เข้าสู่ระบบ
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="col col-xl-6">
        <div class="d-flex justify-content-center">
            <img class="img-s" src="Image/bgauditlogin.png" />
        </div>
    </div>

</div>

<div class="modal fade" id="confirmOTP" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header modal-ext" style="">
                <button class="btn" type="button" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fa-regular fa-circle-xmark fa-2xl " style="color:#fff"></i>
                </button>
            </div>
            <div class="modal-body" align="center">
                <div class="position-relative">
                    <div class="p-2 text-center">
                        <div class="m-2">
                            <svg width="96" height="96" viewBox="0 0 96 96" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="48" cy="48" r="48" fill="#C5CBE6" />
                                <path d="M48.1688 51.1899C55.6743 51.1899 61.7638 45.1005 61.7638 37.5949C61.7638 30.0894 55.6743 24 48.1688 24C40.6633 24 34.5739 30.0894 34.5739 37.5949C34.5739 45.1005 40.6633 51.1899 48.1688 51.1899ZM60.2532 54.211H55.0512C52.9554 55.174 50.6234 55.7215 48.1688 55.7215C45.7142 55.7215 43.3917 55.174 41.2864 54.211H36.0844C29.4097 54.211 24 59.6207 24 66.2954V67.806C24 70.3078 26.0298 72.3376 28.5317 72.3376H67.806C70.3078 72.3376 72.3376 70.3078 72.3376 67.806V66.2954C72.3376 59.6207 66.9279 54.211 60.2532 54.211Z" fill="#334396" />
                            </svg>
                        </div>
                        <div class="modal-otp">ยืนยันตัวตนด้วย OTP</div>
                        <div>
                            <span>กรุณากรอกเลข OTP ที่ได้รับทาง</span>  <br />
                            <span>E-mail :</span> <small> sso-mms@sso.com</small>
                        </div>
                        <div id="otp" class="inputs d-flex flex-row justify-content-center mt-2">
                            <input class="m-2 text-center form-control rounded" type="text" id="first" maxlength="1" />
                            <input class="m-2 text-center form-control rounded" type="text" id="second" maxlength="1" />
                            <input class="m-2 text-center form-control rounded" type="text" id="third" maxlength="1" />
                            <input class="m-2 text-center form-control rounded" type="text" id="fourth" maxlength="1" />
                            <input class="m-2 text-center form-control rounded" type="text" id="fifth" maxlength="1" />
                            <input class="m-2 text-center form-control rounded" type="text" id="sixth" maxlength="1" />
                        </div>
                        <div class="mt-4 txt-times ">
                            02:59 นาที
                        </div>
                        <div class="mt-4"> <button class="btn btn-primary btn-otp px-4 validate"> ยืนยัน OTP</button> </div>
                    </div>
                    <div class="card-2">
                        <div class="content d-flex justify-content-center align-items-center">
                            <span>ท่านไม่ได้รับเลข OTP ? </span> <a href="#" class="text-decoration-none ms-3">ส่งอีกครั้ง</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool showPassword = false;
    private bool isLoading = false;
    private string? username;
    private string? password;

    public string? env = ConfigureCore.ConfigENV;
    public string? url;
    public string? urlLogin;

    private ResponseLoginTokenKeyCloak responseLoginTokenKeyCloak { get; set; } = null!;

    protected override void OnInitialized()
    {
        url = ConfigureCore.redirectsPortalAdmin;
        urlLogin = ConfigureCore.redirectLogin;
    }


    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
        StateHasChanged();
    }

    public async Task IsLogin()
    {

        isLoading = true;
        responseLoginTokenKeyCloak = await keyCloakService.LoginKeyCloak(username!, password!, "sso-mms-admin");
        Console.WriteLine("keycloakresponse {0}", responseLoginTokenKeyCloak);
        if (responseLoginTokenKeyCloak != null)
        {
            await localStorage.SetItemAsync("accessToken", responseLoginTokenKeyCloak.access_token);
            await localStorage.SetItemAsync("username", username);
            await localStorage.SetItemAsync("shortToken", responseLoginTokenKeyCloak.shortToken);

            Console.WriteLine("shortToken {0}", responseLoginTokenKeyCloak.shortToken);
            NavigationManager.NavigateTo(url + $"mainmenu?token={responseLoginTokenKeyCloak.shortToken}");
            //await JSRuntime.InvokeAsync<object>("open", url + $"portal?token={responseLoginTokenKeyCloak.shortToken}", "_blank");
        }
        else
        {
            await JsRuntime.InvokeVoidAsync("alert", "UserName Or Password is Incorrect!");
            isLoading = false;
        }
    }

    public async Task SendTokenToAnotherApp()
    {
        var token = localStorage.GetItemAsync<string>("accessToken");
    }
}
